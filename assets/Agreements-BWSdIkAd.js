import{c as Q,r as c,j as e,f as m,a as re,bw as me,a8 as xe,bb as pe,aJ as he,bx as ge,by as fe,bz as je,bA as ve,bB as be,bC as ye,a1 as $,af as te,B as X,e as Y,d as Ne,g as ie,G as ae,t as o,T as we,bD as _e,bE as Ce,bF as Se,bG as ke,bH as De,bI as Ae,$ as Re,bJ as Me}from"./index-GzcG7CSS.js";import{C as G}from"./Card-FSc1waky.js";import{B as O}from"./Badge-9_pL70Ln.js";import{M as K}from"./Modal-CA0K5bCb.js";import{u as Te}from"./usePageTitle-CSRQyC0a.js";import{F as Fe}from"./funnel-fE0ZCBlq.js";import{C as le}from"./circle-check-DXK6A2lJ.js";import{P as ne}from"./paperclip-CDP-dEKu.js";import{D as ze}from"./download-COygb2Hf.js";import{U as qe}from"./upload-DVvKjw19.js";import{M as Pe}from"./mail-BeMqAM3p.js";import{R as Ee}from"./rotate-ccw-B_YISXRo.js";import{C as V}from"./circle-x-BhxGvoPR.js";const Le=[["path",{d:"M21 21H8a2 2 0 0 1-1.42-.587l-3.994-3.999a2 2 0 0 1 0-2.828l10-10a2 2 0 0 1 2.829 0l5.999 6a2 2 0 0 1 0 2.828L12.834 21",key:"g5wo59"}],["path",{d:"m5.082 11.09 8.828 8.828",key:"1wx5vj"}]],Ue=Q("eraser",Le);const Ie=[["path",{d:"M15.707 21.293a1 1 0 0 1-1.414 0l-1.586-1.586a1 1 0 0 1 0-1.414l5.586-5.586a1 1 0 0 1 1.414 0l1.586 1.586a1 1 0 0 1 0 1.414z",key:"nt11vn"}],["path",{d:"m18 13-1.375-6.874a1 1 0 0 0-.746-.776L3.235 2.028a1 1 0 0 0-1.207 1.207L5.35 15.879a1 1 0 0 0 .776.746L13 18",key:"15qc1e"}],["path",{d:"m2.3 2.3 7.286 7.286",key:"1wuzzi"}],["circle",{cx:"11",cy:"11",r:"2",key:"xmgehs"}]],H=Q("pen-tool",Ie);const Be=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],$e=Q("pen",Be);function Ge({onSave:h,onCancel:x,saving:y}){const j=c.useRef(null),[P,u]=c.useState(!1),[N,S]=c.useState(!1),w=c.useCallback(()=>{const r=j.current;return r?r.getContext("2d"):null},[]);c.useEffect(()=>{const r=j.current;if(!r)return;const i=r.getBoundingClientRect();r.width=i.width*2,r.height=i.height*2;const l=r.getContext("2d");l&&(l.scale(2,2),l.fillStyle="#ffffff",l.fillRect(0,0,i.width,i.height),l.strokeStyle="#1e293b",l.lineWidth=2,l.lineCap="round",l.lineJoin="round")},[]);const M=r=>{const i=j.current;if(!i)return{x:0,y:0};const l=i.getBoundingClientRect();return"touches"in r?{x:r.touches[0].clientX-l.left,y:r.touches[0].clientY-l.top}:{x:r.clientX-l.left,y:r.clientY-l.top}},T=r=>{r.preventDefault();const i=w();if(!i)return;const{x:l,y:v}=M(r);i.beginPath(),i.moveTo(l,v),u(!0)},k=r=>{if(r.preventDefault(),!P)return;const i=w();if(!i)return;const{x:l,y:v}=M(r);i.lineTo(l,v),i.stroke(),S(!0)},g=()=>{u(!1)},_=()=>{const r=j.current;if(!r)return;const i=r.getContext("2d");if(!i)return;const l=r.getBoundingClientRect();i.fillStyle="#ffffff",i.fillRect(0,0,l.width,l.height),S(!1)},D=()=>{const r=j.current;!r||!N||h(r.toDataURL("image/png"))};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-stone-500",children:[e.jsx($e,{className:"w-4 h-4"}),e.jsx("span",{children:"Draw your signature below"})]}),e.jsxs("button",{onClick:_,className:"flex items-center gap-1.5 text-xs text-stone-500 hover:text-stone-700 transition-colors",children:[e.jsx(Ue,{className:"w-3.5 h-3.5"}),"Clear"]})]}),e.jsxs("div",{className:"relative border-2 border-dashed border-stone-300 rounded-xl overflow-hidden bg-white",children:[e.jsx("canvas",{ref:j,className:"w-full cursor-crosshair touch-none",style:{height:180},onMouseDown:T,onMouseMove:k,onMouseUp:g,onMouseLeave:g,onTouchStart:T,onTouchMove:k,onTouchEnd:g}),e.jsx("div",{className:"absolute bottom-8 left-8 right-8 border-b border-stone-300"}),e.jsx("div",{className:"absolute bottom-3 left-8 text-[10px] text-stone-400 tracking-wide uppercase",children:"Signature"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(m,{variant:"outline",size:"sm",onClick:x,children:"Cancel"}),e.jsx(m,{size:"sm",onClick:D,disabled:!N||y,children:y?"Submitting...":"Submit Signature"})]})]})}const E={draft:{label:"Draft",variant:"default"},pending_review:{label:"Pending Review",variant:"warning"},active:{label:"Active",variant:"success"},expired:{label:"Expired",variant:"danger"},terminated:{label:"Terminated",variant:"danger"}},W={none:{label:"No Signatures",variant:"default",icon:H},pending:{label:"Awaiting Signatures",variant:"warning",icon:ie},partially_signed:{label:"Partially Signed",variant:"warning",icon:H},fully_signed:{label:"Fully Signed",variant:"success",icon:le}};function Oe({agreement:h}){const{user:x}=re(),y=x?.role==="coordinator"||x?.role==="site_manager"||x?.role==="admin",{data:j,isLoading:P}=_e(h.id),u=j?.data||[],N=Ce(),S=Se(),w=ke(),M=De(),T=Ae(),[k,g]=c.useState(!1),[_,D]=c.useState(null),[r,i]=c.useState(null),[l,v]=c.useState(""),[b,C]=c.useState({signer_name:"",signer_email:"",signer_role:"university",message:""}),A=async()=>{if(!b.signer_name||!b.signer_email){o.error("Name and email are required.");return}try{await N.mutateAsync({agreementId:h.id,data:b}),o.success("Signature request sent!"),g(!1),C({signer_name:"",signer_email:"",signer_role:"university",message:""})}catch(t){o.error(t instanceof Error?t.message:"Failed to send request.")}},F=async t=>{if(_)try{await S.mutateAsync({id:_,data:{signature_data:t}}),o.success("Signature submitted successfully!"),D(null)}catch(d){o.error(d instanceof Error?d.message:"Failed to submit signature.")}},z=async()=>{if(r)try{await w.mutateAsync({id:r,data:{reason:l||void 0}}),o.success("Signature request declined."),i(null),v("")}catch(t){o.error(t instanceof Error?t.message:"Failed to reject.")}},L=t=>t.status==="requested"&&(t.signer_email===x?.email||t.signer_id===x?.id),q=t=>{switch(t){case"signed":return e.jsx(le,{className:"w-4 h-4 text-green-500"});case"requested":return e.jsx(ie,{className:"w-4 h-4 text-amber-500"});case"rejected":return e.jsx(V,{className:"w-4 h-4 text-red-500"});case"cancelled":return e.jsx(V,{className:"w-4 h-4 text-stone-400"});default:return null}};return P?e.jsx("div",{className:"py-3 text-center",children:e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-primary-600 mx-auto"})}):_?e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-stone-500 uppercase tracking-wide mb-3",children:"Sign Agreement"}),e.jsx(Ge,{onSave:F,onCancel:()=>D(null),saving:S.isPending})]}):r?e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-xs font-medium text-stone-500 uppercase tracking-wide",children:"Decline Signature"}),e.jsx("textarea",{value:l,onChange:t=>v(t.target.value),placeholder:"Reason for declining (optional)...",rows:3,className:"w-full border border-stone-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 resize-none"}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(m,{variant:"outline",size:"sm",onClick:()=>{i(null),v("")},children:"Cancel"}),e.jsx(m,{variant:"danger",size:"sm",onClick:z,disabled:w.isPending,children:w.isPending?"Declining...":"Confirm Decline"})]})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("p",{className:"text-xs font-medium text-stone-500 uppercase tracking-wide",children:"E-Signatures"}),y&&e.jsxs("button",{onClick:()=>g(!k),className:"flex items-center gap-1.5 text-xs font-medium text-primary-600 hover:text-primary-700 transition-colors",children:[e.jsx(Re,{className:"w-3.5 h-3.5"}),"Request Signature"]})]}),k&&e.jsxs("div",{className:"bg-primary-50/50 border border-primary-100 rounded-xl p-4 mb-3 space-y-3",children:[e.jsx("p",{className:"text-sm font-medium text-stone-900",children:"Request a Signature"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsx("input",{type:"text",value:b.signer_name,onChange:t=>C(d=>({...d,signer_name:t.target.value})),placeholder:"Signer's full name *",className:"border border-stone-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500"}),e.jsx("input",{type:"email",value:b.signer_email,onChange:t=>C(d=>({...d,signer_email:t.target.value})),placeholder:"Signer's email *",className:"border border-stone-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500"})]}),e.jsxs("select",{value:b.signer_role,onChange:t=>C(d=>({...d,signer_role:t.target.value})),className:"w-full border border-stone-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500",children:[e.jsx("option",{value:"university",children:"University Representative"}),e.jsx("option",{value:"site",children:"Site Representative"})]}),e.jsx("textarea",{value:b.message,onChange:t=>C(d=>({...d,message:t.target.value})),placeholder:"Personal message (optional)...",rows:2,className:"w-full border border-stone-200 rounded-lg px-3 py-2 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500"}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(m,{variant:"outline",size:"sm",onClick:()=>g(!1),children:"Cancel"}),e.jsxs(m,{size:"sm",onClick:A,disabled:N.isPending,children:[e.jsx(Pe,{className:"w-3.5 h-3.5 mr-1.5"}),N.isPending?"Sending...":"Send Request"]})]})]}),u.length===0?e.jsxs("div",{className:"text-center py-4 bg-stone-50 rounded-xl",children:[e.jsx(H,{className:"w-6 h-6 text-stone-300 mx-auto mb-1"}),e.jsxs("p",{className:"text-xs text-stone-400",children:["No signatures yet",y?" — request one above":""]})]}):e.jsx("div",{className:"space-y-2",children:u.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-stone-50 rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[q(t.status),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-stone-900 truncate",children:t.signer_name}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-stone-500",children:[e.jsx("span",{children:t.signer_email}),e.jsx("span",{className:"text-stone-300",children:"|"}),e.jsxs("span",{className:"capitalize",children:[t.signer_role," rep."]}),t.signed_at&&e.jsx("span",{className:"text-stone-300",children:"|"}),t.signed_at&&e.jsxs("span",{children:["Signed ",new Date(t.signed_at).toLocaleDateString()]}),t.rejected_at&&e.jsx("span",{className:"text-stone-300",children:"|"}),t.rejected_at&&e.jsxs("span",{className:"text-red-500",children:["Declined ",new Date(t.rejected_at).toLocaleDateString()]})]}),t.rejection_reason&&e.jsxs("p",{className:"text-xs text-red-500 mt-0.5",children:["Reason: ",t.rejection_reason]})]})]}),e.jsxs("div",{className:"flex items-center gap-1.5 shrink-0 ml-2",children:[t.status==="signed"&&t.signature_data&&e.jsx("img",{src:t.signature_data,alt:"Signature",className:"h-8 w-16 object-contain border border-stone-200 rounded bg-white"}),L(t)&&e.jsxs(e.Fragment,{children:[e.jsxs(m,{size:"sm",onClick:()=>D(t.id),children:[e.jsx(H,{className:"w-3.5 h-3.5 mr-1"})," Sign"]}),e.jsx(m,{variant:"outline",size:"sm",onClick:()=>i(t.id),children:"Decline"})]}),t.status==="requested"&&y&&!L(t)&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>T.mutate(t.id,{onSuccess:()=>o.success("Reminder sent!"),onError:d=>o.error(d.message)}),className:"p-1.5 rounded-lg text-stone-400 hover:text-primary-600 hover:bg-primary-50 transition-colors",title:"Resend request",children:e.jsx(Ee,{className:"w-3.5 h-3.5"})}),e.jsx("button",{onClick:()=>M.mutate(t.id,{onSuccess:()=>o.success("Request cancelled."),onError:d=>o.error(d.message)}),className:"p-1.5 rounded-lg text-stone-400 hover:text-red-600 hover:bg-red-50 transition-colors",title:"Cancel request",children:e.jsx(V,{className:"w-3.5 h-3.5"})})]})]})]},t.id))})]})}function ns(){Te("Agreements");const{user:h}=re(),x=h?.role==="coordinator"||h?.role==="site_manager"||h?.role==="admin",y=h?.role==="site_manager"||h?.role==="admin",{data:j,isLoading:P}=me(),u=j?.agreements||[],{data:N}=xe(),S=N?.sites||[],{data:w}=pe(),M=w?.data||[],{data:T}=he(),k=T?.data||[],g=ge(),_=fe(),D=je(),{data:r}=ve(),i=r||[],l=be(),v=ye(),[b,C]=c.useState(!1),[A,F]=c.useState({name:"",description:"",default_notes:""}),[z,L]=c.useState(""),[q,t]=c.useState("all"),[d,U]=c.useState(!1),[n,J]=c.useState(null),I=c.useRef(new Map),[p,R]=c.useState({university_id:"",site_id:"",start_date:"",end_date:"",notes:""}),Z=c.useMemo(()=>u.filter(s=>{if(q!=="all"&&s.status!==q)return!1;if(z){const a=z.toLowerCase();return s.university?.name?.toLowerCase().includes(a)||s.site?.name?.toLowerCase().includes(a)||s.notes?.toLowerCase().includes(a)}return!0}),[u,z,q]),B=c.useMemo(()=>({total:u.length,active:u.filter(s=>s.status==="active").length,pending:u.filter(s=>s.status==="pending_review").length,expired:u.filter(s=>s.status==="expired").length}),[u]),oe=async()=>{if(!p.university_id||!p.site_id){o.error("Please select both a university and a site.");return}try{await g.mutateAsync({university_id:p.university_id,site_id:p.site_id,start_date:p.start_date||void 0,end_date:p.end_date||void 0,notes:p.notes||void 0}),o.success("Agreement created successfully."),U(!1),R({university_id:"",site_id:"",start_date:"",end_date:"",notes:""})}catch(s){o.error(s instanceof Error?s.message:"Failed to create agreement.")}},ce=async(s,a)=>{try{await _.mutateAsync({id:s.id,data:{status:a}}),o.success(`Agreement status updated to ${E[a]?.label||a}.`),J(null)}catch(f){o.error(f instanceof Error?f.message:"Failed to update status.")}},ee=async(s,a)=>{try{await D.mutateAsync({id:s,file:a}),o.success("Document uploaded successfully.")}catch(f){o.error(f instanceof Error?f.message:"Failed to upload document.")}},de=s=>{const a=localStorage.getItem("cliniclink_token"),f=Me.downloadUrl(s);window.open(`${f}?token=${a}`,"_blank")},se=s=>s<1024?`${s} B`:s<1024*1024?`${(s/1024).toFixed(1)} KB`:`${(s/(1024*1024)).toFixed(1)} MB`,ue=s=>{const a=[];switch(s.status){case"draft":a.push({label:"Submit for Review",status:"pending_review",variant:"primary"});break;case"pending_review":y&&a.push({label:"Approve",status:"active",variant:"primary"}),a.push({label:"Back to Draft",status:"draft",variant:"outline"});break;case"active":a.push({label:"Mark Expired",status:"expired",variant:"danger"}),a.push({label:"Terminate",status:"terminated",variant:"danger"});break;case"expired":a.push({label:"Reactivate",status:"active",variant:"primary"});break}return a};return P?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-stone-900",children:"Affiliation Agreements"}),e.jsx("p",{className:"text-stone-500 mt-1",children:"Manage university-site affiliation agreements and documentation"})]}),x&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(m,{variant:"outline",onClick:()=>C(!0),children:[e.jsx($,{className:"w-4 h-4 mr-2"}),"Templates"]}),e.jsxs(m,{onClick:()=>U(!0),children:[e.jsx(te,{className:"w-4 h-4 mr-2"}),"New Agreement"]})]})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[{label:"Total",value:B.total,icon:$,color:"text-stone-600"},{label:"Active",value:B.active,icon:X,color:"text-green-600"},{label:"Pending Review",value:B.pending,icon:Y,color:"text-amber-600"},{label:"Expired",value:B.expired,icon:$,color:"text-red-600"}].map(s=>e.jsx(G,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(s.icon,{className:`w-5 h-5 ${s.color}`}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-stone-900",children:s.value}),e.jsx("p",{className:"text-xs text-stone-500",children:s.label})]})]})},s.label))}),e.jsx(G,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Ne,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-stone-400"}),e.jsx("input",{type:"text",placeholder:"Search by university or site name...",value:z,onChange:s=>L(s.target.value),className:"w-full pl-10 pr-4 py-2 border border-stone-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"w-4 h-4 text-stone-400"}),e.jsxs("select",{value:q,onChange:s=>t(s.target.value),className:"border border-stone-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500",children:[e.jsx("option",{value:"all",children:"All Statuses"}),e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"pending_review",children:"Pending Review"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"expired",children:"Expired"}),e.jsx("option",{value:"terminated",children:"Terminated"})]})]})]})}),Z.length===0?e.jsxs(G,{className:"p-12 text-center",children:[e.jsx($,{className:"w-12 h-12 text-stone-300 mx-auto mb-3"}),e.jsx("p",{className:"text-stone-500 font-medium",children:"No agreements found"}),e.jsx("p",{className:"text-sm text-stone-400 mt-1",children:u.length===0?"Create your first affiliation agreement to get started.":"Try adjusting your filters."})]}):e.jsx("div",{className:"space-y-3",children:Z.map(s=>{const a=W[s.signature_status]||W.none;return e.jsx(G,{className:"p-5 hover:shadow-md transition-shadow cursor-pointer",onClick:()=>J(s),children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(ae,{className:"w-4 h-4 text-primary-500 shrink-0"}),e.jsx("span",{className:"font-semibold text-stone-900 truncate",children:s.university?.name||"Unknown University"}),e.jsx("span",{className:"text-stone-400 mx-1",children:"↔"}),e.jsx(X,{className:"w-4 h-4 text-secondary-500 shrink-0"}),e.jsx("span",{className:"font-semibold text-stone-900 truncate",children:s.site?.name||"Unknown Site"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-xs text-stone-500 mt-1",children:[s.start_date&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Y,{className:"w-3 h-3"}),new Date(s.start_date).toLocaleDateString()," – ",s.end_date?new Date(s.end_date).toLocaleDateString():"No end date"]}),s.file_name&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ne,{className:"w-3 h-3"}),s.file_name,s.file_size&&` (${se(s.file_size)})`]}),s.creator&&e.jsxs("span",{children:["Created by ",s.creator.first_name," ",s.creator.last_name]})]}),s.notes&&e.jsx("p",{className:"text-xs text-stone-400 mt-1 truncate",children:s.notes})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[s.signature_status&&s.signature_status!=="none"&&e.jsxs(O,{variant:a.variant,children:[e.jsx(a.icon,{className:"w-3 h-3 mr-1"}),a.label]}),e.jsx(O,{variant:E[s.status]?.variant||"default",children:E[s.status]?.label||s.status})]})]})},s.id)})}),e.jsx(K,{isOpen:d,title:"New Affiliation Agreement",onClose:()=>U(!1),children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-stone-700 mb-1",children:"University *"}),e.jsxs("select",{value:p.university_id,onChange:s=>R(a=>({...a,university_id:s.target.value})),className:"w-full border border-stone-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500",children:[e.jsx("option",{value:"",children:"Select university..."}),k.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-stone-700 mb-1",children:"Clinical Site *"}),e.jsxs("select",{value:p.site_id,onChange:s=>R(a=>({...a,site_id:s.target.value})),className:"w-full border border-stone-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500",children:[e.jsx("option",{value:"",children:"Select site..."}),(h?.role==="site_manager"?S:M).map(s=>e.jsxs("option",{value:s.id,children:[s.name," — ",s.city,", ",s.state]},s.id))]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-stone-700 mb-1",children:"Start Date"}),e.jsx("input",{type:"date",value:p.start_date,onChange:s=>R(a=>({...a,start_date:s.target.value})),className:"w-full border border-stone-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-stone-700 mb-1",children:"End Date"}),e.jsx("input",{type:"date",value:p.end_date,onChange:s=>R(a=>({...a,end_date:s.target.value})),className:"w-full border border-stone-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500"})]})]}),i.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-stone-700 mb-1",children:"Use Template"}),e.jsxs("select",{onChange:s=>{const a=i.find(f=>f.id===s.target.value);a&&R(f=>({...f,notes:a.default_notes||""}))},className:"w-full border border-stone-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500",defaultValue:"",children:[e.jsx("option",{value:"",children:"Select a template to prefill notes..."}),i.map(s=>e.jsxs("option",{value:s.id,children:[s.name,s.description?` — ${s.description}`:""]},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-stone-700 mb-1",children:"Notes"}),e.jsx("textarea",{value:p.notes,onChange:s=>R(a=>({...a,notes:s.target.value})),rows:3,placeholder:"Additional notes about the agreement...",className:"w-full border border-stone-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 resize-none"})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx(m,{variant:"outline",onClick:()=>U(!1),children:"Cancel"}),e.jsx(m,{onClick:oe,disabled:g.isPending,children:g.isPending?"Creating...":"Create Agreement"})]})]})}),e.jsx(K,{isOpen:!!n,title:"Agreement Details",onClose:()=>J(null),size:"lg",children:n&&e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-3 bg-primary-50 rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(ae,{className:"w-4 h-4 text-primary-600"}),e.jsx("span",{className:"text-xs font-medium text-primary-600 uppercase tracking-wide",children:"University"})]}),e.jsx("p",{className:"font-semibold text-stone-900",children:n.university?.name}),n.university?.city&&n.university?.state&&e.jsxs("p",{className:"text-xs text-stone-500",children:[n.university.city,", ",n.university.state]})]}),e.jsxs("div",{className:"p-3 bg-secondary-50 rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(X,{className:"w-4 h-4 text-secondary-600"}),e.jsx("span",{className:"text-xs font-medium text-secondary-600 uppercase tracking-wide",children:"Clinical Site"})]}),e.jsx("p",{className:"font-semibold text-stone-900",children:n.site?.name}),n.site?.city&&n.site?.state&&e.jsxs("p",{className:"text-xs text-stone-500",children:[n.site.city,", ",n.site.state]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx(O,{variant:E[n.status]?.variant||"default",children:E[n.status]?.label||n.status}),n.signature_status&&n.signature_status!=="none"&&(()=>{const s=W[n.signature_status];return e.jsxs(O,{variant:s.variant,children:[e.jsx(s.icon,{className:"w-3 h-3 mr-1"}),s.label]})})(),n.start_date&&e.jsxs("span",{className:"text-sm text-stone-500 flex items-center gap-1",children:[e.jsx(Y,{className:"w-3.5 h-3.5"}),new Date(n.start_date).toLocaleDateString(),n.end_date&&` – ${new Date(n.end_date).toLocaleDateString()}`]})]}),n.notes&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-stone-500 uppercase tracking-wide mb-1",children:"Notes"}),e.jsx("p",{className:"text-sm text-stone-700 whitespace-pre-wrap",children:n.notes})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-stone-500 uppercase tracking-wide mb-2",children:"Document"}),n.file_name?e.jsxs("div",{className:"flex items-center justify-between p-3 bg-stone-50 rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx(ne,{className:"w-4 h-4 text-stone-400 shrink-0"}),e.jsx("span",{className:"text-sm text-stone-700 truncate",children:n.file_name}),n.file_size&&e.jsxs("span",{className:"text-xs text-stone-400 shrink-0",children:["(",se(n.file_size),")"]})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[e.jsx("button",{onClick:()=>de(n.id),className:"text-primary-600 hover:text-primary-700 p-1",title:"Download",children:e.jsx(ze,{className:"w-4 h-4"})}),x&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>I.current.get(n.id)?.click(),className:"text-xs text-stone-500 hover:text-stone-700",children:"Replace"}),e.jsx("input",{type:"file",ref:s=>{s&&I.current.set(n.id,s)},onChange:s=>{const a=s.target.files?.[0];a&&ee(n.id,a),s.target.value=""},accept:".pdf,.jpg,.jpeg,.png,.doc,.docx",className:"hidden"})]})]})]}):x?e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>I.current.get(n.id)?.click(),className:"flex items-center gap-2 px-3 py-2 text-sm text-primary-600 hover:text-primary-700 border border-dashed border-primary-300 rounded-xl hover:bg-primary-50 transition-colors",children:[e.jsx(qe,{className:"w-4 h-4"}),"Upload Document"]}),e.jsx("input",{type:"file",ref:s=>{s&&I.current.set(n.id,s)},onChange:s=>{const a=s.target.files?.[0];a&&ee(n.id,a),s.target.value=""},accept:".pdf,.jpg,.jpeg,.png,.doc,.docx",className:"hidden"})]}):e.jsx("p",{className:"text-sm text-stone-400 italic",children:"No document attached"})]}),e.jsx("div",{className:"border-t border-stone-200 pt-4",children:e.jsx(Oe,{agreement:n})}),x&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-stone-500 uppercase tracking-wide mb-2",children:"Actions"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:ue(n).map(s=>e.jsx(m,{variant:s.variant,size:"sm",onClick:()=>ce(n,s.status),disabled:_.isPending,children:s.label},s.status))})]})]})}),e.jsx(K,{isOpen:b,title:"Agreement Templates",onClose:()=>C(!1),children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-stone-50 rounded-xl p-4 space-y-3",children:[e.jsx("p",{className:"text-sm font-medium text-stone-900",children:"Create Template"}),e.jsx("input",{type:"text",value:A.name,onChange:s=>F(a=>({...a,name:s.target.value})),placeholder:"Template name...",className:"w-full border border-stone-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500"}),e.jsx("input",{type:"text",value:A.description,onChange:s=>F(a=>({...a,description:s.target.value})),placeholder:"Description (optional)...",className:"w-full border border-stone-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500"}),e.jsx("textarea",{value:A.default_notes,onChange:s=>F(a=>({...a,default_notes:s.target.value})),placeholder:"Default notes to prefill when using this template...",rows:3,className:"w-full border border-stone-200 rounded-lg px-3 py-2 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500"}),e.jsxs(m,{size:"sm",onClick:()=>{if(!A.name){o.error("Template name is required");return}l.mutate(A,{onSuccess:()=>{o.success("Template created"),F({name:"",description:"",default_notes:""})},onError:s=>o.error(s.message)})},disabled:l.isPending,children:[e.jsx(te,{className:"w-4 h-4"})," Create Template"]})]}),e.jsx("div",{className:"divide-y divide-stone-100",children:i.length===0?e.jsx("p",{className:"text-sm text-stone-400 py-4 text-center",children:"No templates yet. Create one above."}):i.map(s=>e.jsxs("div",{className:"py-3 flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-stone-900",children:s.name}),s.description&&e.jsx("p",{className:"text-xs text-stone-500",children:s.description}),s.default_notes&&e.jsx("p",{className:"text-xs text-stone-400 mt-1 line-clamp-2",children:s.default_notes})]}),e.jsx("button",{onClick:()=>v.mutate(s.id,{onSuccess:()=>o.success("Template deleted")}),className:"p-1.5 rounded-lg text-stone-400 hover:text-red-600 hover:bg-red-50 transition-colors shrink-0",title:"Delete template",children:e.jsx(we,{className:"w-4 h-4"})})]},s.id))})]})})]})}export{ns as Agreements};
