import{r as a,ca as $,cb as z,j as e,f as l,af as B,w as U,K as A,v as I,T as F,t as o,cc as O,p as K,B as q,X,d as H}from"./index-GzcG7CSS.js";import{C as J}from"./Card-FSc1waky.js";import{B as S}from"./Badge-9_pL70Ln.js";import{M as T}from"./Modal-CA0K5bCb.js";import{u as Q}from"./usePageTitle-CSRQyC0a.js";import{C as L}from"./copy-CERpL2dH.js";import{C as V}from"./chevron-left-Be6DhBVQ.js";import{C as W}from"./chevron-right-D8jrJqqK.js";function oe(){Q("License Codes");const[h,D]=a.useState(""),[d,v]=a.useState(1),[j,w]=a.useState(!1),[x,f]=a.useState(null),[m,c]=a.useState(null),{data:g,isLoading:N}=$({university_id:h||void 0,page:d}),C=z(),b=g?.data??[],u=g?.last_page??1,k=(s,i)=>{navigator.clipboard.writeText(s),c(i),o.success("Code copied to clipboard"),setTimeout(()=>c(null),2e3)},_=(s,i)=>{const r=`${window.location.origin}/register?role=student&code=${s}`;navigator.clipboard.writeText(r),c(i),o.success("Registration link copied"),setTimeout(()=>c(null),2e3)},y=async()=>{if(x)try{await C.mutateAsync(x.id),o.success("Code deactivated"),f(null)}catch(s){const i=s instanceof Error?s.message:"Failed to deactivate code";o.error(i)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-stone-900",children:"University License Codes"}),e.jsx("p",{className:"text-stone-500 mt-1",children:"Generate and manage Pro access codes for university students"})]}),e.jsxs(l,{onClick:()=>w(!0),children:[e.jsx(B,{className:"w-4 h-4 mr-2"}),"Generate Codes"]})]}),e.jsxs(J,{padding:"none",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-stone-200 bg-stone-50",children:[e.jsx("th",{className:"text-left px-4 py-3 text-xs font-semibold text-stone-500 uppercase tracking-wider",children:"Code"}),e.jsx("th",{className:"text-left px-4 py-3 text-xs font-semibold text-stone-500 uppercase tracking-wider",children:"University"}),e.jsx("th",{className:"text-left px-4 py-3 text-xs font-semibold text-stone-500 uppercase tracking-wider",children:"Usage"}),e.jsx("th",{className:"text-left px-4 py-3 text-xs font-semibold text-stone-500 uppercase tracking-wider",children:"Expires"}),e.jsx("th",{className:"text-left px-4 py-3 text-xs font-semibold text-stone-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"text-left px-4 py-3 text-xs font-semibold text-stone-500 uppercase tracking-wider",children:"Created"}),e.jsx("th",{className:"text-right px-4 py-3 text-xs font-semibold text-stone-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-stone-100",children:N?e.jsx("tr",{children:e.jsxs("td",{colSpan:7,className:"px-4 py-12 text-center",children:[e.jsx(U,{className:"w-6 h-6 animate-spin text-stone-400 mx-auto"}),e.jsx("p",{className:"text-sm text-stone-500 mt-2",children:"Loading codes..."})]})}):b.length===0?e.jsx("tr",{children:e.jsxs("td",{colSpan:7,className:"px-4 py-12 text-center",children:[e.jsx(A,{className:"w-8 h-8 text-stone-300 mx-auto"}),e.jsx("p",{className:"text-sm text-stone-500 mt-2",children:"No license codes yet"}),e.jsx("p",{className:"text-xs text-stone-400 mt-1",children:"Generate codes for universities to distribute to their students"})]})}):b.map(s=>{const i=s.expires_at&&new Date(s.expires_at)<new Date,r=s.max_uses!==null&&s.times_used>=s.max_uses,E=s.is_active&&!i&&!r;return e.jsxs("tr",{className:"table-row-hover",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("code",{className:"text-sm font-mono font-semibold text-stone-900 bg-stone-100 px-2 py-0.5 rounded",children:s.code}),e.jsx("button",{onClick:()=>k(s.code,s.id),className:"p-1 rounded hover:bg-stone-200 transition-colors text-stone-400 hover:text-stone-600",title:"Copy code",children:m===s.id?e.jsx(I,{className:"w-3.5 h-3.5 text-green-500"}):e.jsx(L,{className:"w-3.5 h-3.5"})})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"text-sm text-stone-700",children:s.university?.name??"—"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("span",{className:"text-sm text-stone-700",children:[s.times_used," / ",s.max_uses??"∞"]})}),e.jsx("td",{className:"px-4 py-3",children:s.expires_at?e.jsx("span",{className:`text-sm ${i?"text-red-500":"text-stone-700"}`,children:new Date(s.expires_at).toLocaleDateString()}):e.jsx("span",{className:"text-sm text-stone-400",children:"Never"})}),e.jsx("td",{className:"px-4 py-3",children:s.is_active?i?e.jsx(S,{variant:"warning",children:"Expired"}):r?e.jsx(S,{variant:"secondary",children:"Used"}):e.jsx(S,{variant:"success",children:"Active"}):e.jsx(S,{variant:"danger",children:"Deactivated"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"text-sm text-stone-500",children:new Date(s.created_at).toLocaleDateString()})}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[e.jsx("button",{onClick:()=>_(s.code,s.id+"-link"),className:"px-2 py-1 text-xs font-medium text-primary-600 hover:bg-primary-50 rounded-lg transition-colors",title:"Copy registration link",children:"Copy Link"}),E&&e.jsx("button",{onClick:()=>f(s),className:"p-1.5 rounded-lg hover:bg-red-50 text-stone-400 hover:text-red-500 transition-colors",title:"Deactivate code",children:e.jsx(F,{className:"w-4 h-4"})})]})})]},s.id)})})]})}),u>1&&e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-t border-stone-200",children:[e.jsxs("p",{className:"text-sm text-stone-500",children:["Page ",d," of ",u]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l,{variant:"outline",size:"sm",disabled:d<=1,onClick:()=>v(s=>s-1),children:e.jsx(V,{className:"w-4 h-4"})}),e.jsx(l,{variant:"outline",size:"sm",disabled:d>=u,onClick:()=>v(s=>s+1),children:e.jsx(W,{className:"w-4 h-4"})})]})]})]}),j&&e.jsx(Y,{onClose:()=>w(!1)}),x&&e.jsx(T,{isOpen:!0,onClose:()=>f(null),title:"Deactivate Code",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-sm text-stone-600",children:["Are you sure you want to deactivate code ",e.jsx("code",{className:"font-mono font-semibold bg-stone-100 px-1.5 py-0.5 rounded",children:x.code}),"? This code will no longer be usable by students."]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(l,{variant:"outline",onClick:()=>f(null),children:"Cancel"}),e.jsx(l,{variant:"danger",onClick:y,isLoading:C.isPending,children:"Deactivate"})]})]})})]})}function Y({onClose:h}){const D=O(),[d,v]=a.useState(""),[j,w]=a.useState(1),[x,f]=a.useState(""),[m,c]=a.useState(""),[g,N]=a.useState([]),[C,b]=a.useState(!1),[u,k]=a.useState(null),[_,y]=a.useState(!1),s=a.useRef(null),i=a.useRef(null),[r,E]=a.useState([]);a.useEffect(()=>{if(!m.trim()||m.length<2){N([]);return}b(!0),i.current&&clearTimeout(i.current),i.current=setTimeout(async()=>{try{const t=await K.list({search:m});N((t.data||[]).map(n=>({id:n.id,name:n.name,city:n.city,state:n.state})))}catch{N([])}finally{b(!1)}},300)},[m]),a.useEffect(()=>{const t=n=>{s.current&&!s.current.contains(n.target)&&y(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]);const M=async t=>{if(t.preventDefault(),!d){o.error("Please select a university");return}try{const n=await D.mutateAsync({university_id:d,count:j,expires_at:x||void 0}),p=[];n.code&&p.push(n.code.code),n.codes&&p.push(...n.codes.map(G=>G.code)),E(p),o.success(`${p.length} code${p.length>1?"s":""} generated successfully`)}catch(n){const p=n instanceof Error?n.message:"Failed to generate codes";o.error(p)}},P=()=>{navigator.clipboard.writeText(r.join(`
`)),o.success("All codes copied to clipboard")},R=()=>{const t=r.map(n=>`${window.location.origin}/register?role=student&code=${n}`);navigator.clipboard.writeText(t.join(`
`)),o.success("All registration links copied")};return r.length>0?e.jsx(T,{isOpen:!0,onClose:h,title:"Codes Generated",size:"lg",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-stone-600",children:[r.length," code",r.length>1?"s":""," generated for ",e.jsx("span",{className:"font-semibold",children:u?.name})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(l,{variant:"outline",size:"sm",onClick:P,children:[e.jsx(L,{className:"w-3.5 h-3.5 mr-1.5"}),"Copy Codes"]}),e.jsxs(l,{variant:"outline",size:"sm",onClick:R,children:[e.jsx(L,{className:"w-3.5 h-3.5 mr-1.5"}),"Copy Links"]})]})]}),e.jsx("div",{className:"bg-stone-50 rounded-xl border border-stone-200 p-3 max-h-64 overflow-y-auto",children:e.jsx("div",{className:"space-y-1.5",children:r.map((t,n)=>e.jsxs("div",{className:"flex items-center justify-between bg-white rounded-lg px-3 py-2 border border-stone-100",children:[e.jsx("code",{className:"text-sm font-mono font-semibold text-stone-900",children:t}),e.jsx("button",{onClick:()=>{navigator.clipboard.writeText(t),o.success("Code copied")},className:"p-1 rounded hover:bg-stone-100 text-stone-400 hover:text-stone-600 transition-colors",children:e.jsx(L,{className:"w-3.5 h-3.5"})})]},n))})}),e.jsx("p",{className:"text-xs text-stone-400",children:"Each code is single-use and unique per student. Share these codes with students via email or include them in registration links."}),e.jsx("div",{className:"flex justify-end",children:e.jsx(l,{onClick:h,children:"Done"})})]})}):e.jsx(T,{isOpen:!0,onClose:h,title:"Generate License Codes",children:e.jsxs("form",{onSubmit:M,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-1.5",ref:s,children:[e.jsx("label",{className:"block text-sm font-medium text-stone-700",children:"University"}),u?e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-xl border border-primary-300 bg-primary-50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-4 h-4 text-primary-600"}),e.jsx("span",{className:"text-sm font-medium text-stone-900",children:u.name})]}),e.jsx("button",{type:"button",onClick:()=>{k(null),v(""),c("")},className:"text-stone-400 hover:text-red-500",children:e.jsx(X,{className:"w-4 h-4"})})]}):e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-stone-400",children:C?e.jsx(U,{className:"w-4 h-4 animate-spin"}):e.jsx(H,{className:"w-4 h-4"})}),e.jsx("input",{type:"text",value:m,onChange:t=>{c(t.target.value),y(!0)},onFocus:()=>g.length>0&&y(!0),placeholder:"Search for a university...",className:"w-full rounded-xl border border-stone-300 bg-white pl-10 pr-4 py-2.5 text-sm text-stone-900 placeholder:text-stone-400 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 focus:outline-none transition-all duration-200"}),_&&g.length>0&&e.jsx("div",{className:"absolute z-50 mt-1 w-full bg-white border border-stone-200 rounded-xl shadow-lg max-h-48 overflow-y-auto",children:g.map(t=>e.jsxs("button",{type:"button",onClick:()=>{k({id:t.id,name:t.name}),v(t.id),y(!1),c("")},className:"w-full text-left px-4 py-2.5 hover:bg-primary-50 transition-colors border-b border-stone-100 last:border-0",children:[e.jsx("p",{className:"text-sm font-medium text-stone-900",children:t.name}),(t.city||t.state)&&e.jsx("p",{className:"text-xs text-stone-500",children:[t.city,t.state].filter(Boolean).join(", ")})]},t.id))})]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"block text-sm font-medium text-stone-700",children:"Number of Codes"}),e.jsx("input",{type:"number",min:1,max:500,value:j,onChange:t=>w(Math.min(500,Math.max(1,parseInt(t.target.value)||1))),className:"w-full rounded-xl border border-stone-300 bg-white px-4 py-2.5 text-sm text-stone-900 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 focus:outline-none transition-all duration-200"}),e.jsx("p",{className:"text-xs text-stone-400",children:"Each code is single-use. Generate one per student (max 500 at a time)."})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"block text-sm font-medium text-stone-700",children:"Expiration Date (Optional)"}),e.jsx("input",{type:"date",value:x,onChange:t=>f(t.target.value),min:new Date().toISOString().split("T")[0],className:"w-full rounded-xl border border-stone-300 bg-white px-4 py-2.5 text-sm text-stone-900 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 focus:outline-none transition-all duration-200"}),e.jsx("p",{className:"text-xs text-stone-400",children:"Leave empty for codes that never expire."})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2",children:[e.jsx(l,{type:"button",variant:"outline",onClick:h,children:"Cancel"}),e.jsxs(l,{type:"submit",isLoading:D.isPending,children:[e.jsx(A,{className:"w-4 h-4 mr-2"}),"Generate ",j>1?`${j} Codes`:"Code"]})]})]})})}export{oe as LicenseCodes};
